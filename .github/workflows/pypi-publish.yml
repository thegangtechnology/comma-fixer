name: Publish package to PyPi

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+*'
    branches:
      - jeep/*
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.13'
  PACKAGE_NAME: 'comma-fixer'

jobs:
  check-runner:
    runs-on: ubuntu-latest
    outputs:
      runner-label: ${{ steps.set-runner.outputs.runner-label }}
    steps:
      - name: Set runner
        id: set-runner
        run: |
          runners=$(curl -s -H "Accept: application/vnd.github+json" -H "Authorization: token ${{ secrets.RUNNER_READER_TOKEN }}" "https://api.github.com/orgs/thegangtechnology/actions/runners")
          available=$(echo "$runners" | jq '.runners[] | select(.status == "online" )')
          echo $available
          if [ -n "$available" ]; then
            echo "runner-label=self-hosted"
            echo "runner-label=self-hosted" >> $GITHUB_OUTPUT
          else
            echo "runner-label=ubuntu-latest"
            echo "runner-label=ubuntu-latest" >> $GITHUB_OUTPUT
          fi

  get-env:
    needs: check-runner
    name: Get Environment vars
    runs-on: ${{ needs.check-runner.outputs.runner-label }}
    outputs:
      PYTHON_VERSION: ${{ env.PYTHON_VERSION }}
      PACKAGE_NAME: ${{ env.PACKAGE_NAME }}
      TEST_PUBLISH: ${{ env.TEST_PUBLISH }}
    steps:
      - run: |
          [[ "${{ env.PYTHON_VERSION }}" == "x.yz" ]] && echo "Please set PYTHON_VERSION" && exit 1 || exit 0


  build:
    needs: [ check-runner, get-env ]
    runs-on: ${{ needs.check-runner.outputs.runner-label }}
    timeout-minutes: 20
    steps:
      # clone repository
      - uses: actions/checkout@v4
      # setup python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.get-env.outputs.PYTHON_VERSION }}
      # Install dependencies for build package
      - name: Install pypa/build
        run: >-
          python3 -m
          pip install
          build
          --user
      # Build package
      - name: Build a binary wheel and a source tarball
        run: python3 -m build
      # Save built package as artifact
      - name: Store the distribution packages
        uses: actions/upload-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

  publish-to-pypi:
    name: Publish Python 🐍 distribution 📦 to PyPI
    needs: [ check-runner, get-env, build ]
#    if:  ${{ needs.get-env.outputs.TEST_PUBLISH  == 'false'}}
    runs-on: ${{ needs.check-runner.outputs.runner-label }}
    environment:
      name: pypi
      url: https://pypi.org/p/${{ needs.get-env.outputs.PACKAGE_NAME }}
    permissions:
      id-token: write
    steps:
      # Download built package
      - name: Download all the dists
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/
      # Publish package to pypi
      - name: Publish distribution 📦 to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

#  # Test publish
#  publish-to-testpypi:
#    name: Publish Python 🐍 distribution 📦 to TestPyPI
#    needs: [ check-runner, get-env, build ]
#    if:  ${{ needs.get-env.outputs.TEST_PUBLISH == 'true'}}
#    runs-on: ${{ needs.check-runner.outputs.runner-label }}
#    environment:
#      name: testpypi
#      url: https://test.pypi.org/p/${{ needs.get-env.outputs.PACKAGE_NAME }}
#    permissions:
#      id-token: write  # IMPORTANT: mandatory for trusted publishing
#    steps:
#      # Download built package
#      - name: Download all the dists
#        uses: actions/download-artifact@v4
#        with:
#          name: python-package-distributions
#          path: dist/
#      # Test publish package to pypi
#      - name: Publish distribution 📦 to TestPyPI
#        uses: pypa/gh-action-pypi-publish@release/v1
#        with:
#          repository-url: https://test.pypi.org/legacy/
